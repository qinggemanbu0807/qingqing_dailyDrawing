<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æƒ…æƒ…çš„ä¸“å±ç‰¹æƒå¡æ± </title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Inter å­—ä½“ -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght400;600;800;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(180deg, #f7f3f3 0%, #f0e6ff 100%);
            min-height: 100vh;
        }
        /* ç¡®ä¿å®¹å™¨å…·æœ‰ 3D æ•ˆæœ */
        .card-container {
            transform-style: preserve-3d;
            perspective: 1000px;
            height: 50vh;
            max-height: 400px;
        }
        /* å¡ç‰‡å†…éƒ¨ï¼Œæ§åˆ¶æ•´ä½“ç¿»è½¬ */
        .card-inner {
            transition: transform 0.8s;
            transform-style: preserve-3d;
            position: relative;
        }
        /* é»˜è®¤çŠ¶æ€ä¸‹ï¼Œæ­£é¢ï¼ˆç»“æœï¼‰æ˜¯èƒŒé¢æœä¸Š */
        .card-face {
            backface-visibility: hidden;
            position: absolute;
            width: 100%;
            height: 100%;
            transform: rotateY(180deg);
        }
        /* é»˜è®¤çŠ¶æ€ä¸‹ï¼ŒèƒŒé¢ï¼ˆç‚¹å‡»æŠ½å¡ï¼‰æ˜¯æ­£é¢æœä¸Š */
        .card-back {
            backface-visibility: hidden;
            position: absolute;
            width: 100%;
            height: 100%;
            transform: rotateY(0deg);
        }
        /* ç¿»è½¬çŠ¶æ€ï¼šæ•´ä¸ªå†…éƒ¨å®¹å™¨æ—‹è½¬ 180 åº¦ */
        .flipped .card-inner {
            transform: rotateY(180deg);
        }

        /* ç¨€æœ‰åº¦é¢œè‰² */
        .rarity-S { 
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); 
            color: #8B4513; 
            border: 5px solid #FFD700;
            box-shadow: 0 4px 30px rgba(255, 215, 0, 0.8);
        }
        .rarity-A { 
            background: linear-gradient(135deg, #A8A8A8 0%, #696969 100%); 
            color: #FFFFFF; 
            border: 5px solid #A8A8A8; 
            box-shadow: 0 4px 20px rgba(168, 168, 168, 0.6); 
        }
        .rarity-B { 
            background: linear-gradient(135deg, #B0E0E6 0%, #87CEEB 100%); 
            color: #333333; 
            border: 5px solid #B0E0E6; 
            box-shadow: 0 4px 10px rgba(135, 206, 235, 0.4);
        }
        /* é‡å¤å¡ç‰¹æ•ˆ */
        .rarity-R {
            background: linear-gradient(135deg, #FF69B4 0%, #FF1493 100%); 
            color: #FFFFFF;
            border: 5px solid #FFC0CB;
            box-shadow: 0 4px 30px rgba(255, 20, 147, 0.8);
        }
        
        /* æ ‡é¢˜æ–‡å­—é˜´å½± */
        .text-shadow {
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        /* å“åº”å¼å¸ƒå±€ï¼šæ¡Œé¢ç«¯å¹¶æ’ï¼Œç§»åŠ¨ç«¯å †å  */
        @media (min-width: 1024px) {
            .main-content {
                display: grid;
                grid-template-columns: 2fr 1fr; /* æŠ½å¡åŒºå®½ï¼Œå›¾é‰´åŒºçª„ */
                gap: 24px;
                max-width: 1200px;
            }
        }
        .main-content {
            padding: 1rem;
        }
        .collection-sidebar {
            background-color: #ffffff;
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            max-height: 80vh; /* é™åˆ¶é«˜åº¦æ–¹ä¾¿æ»šåŠ¨ */
            overflow-y: auto;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <h1 class="text-4xl font-black text-gray-800 mb-6 tracking-tight text-shadow mt-4">
        æƒ…æƒ…çš„ä¸“å±ç‰¹æƒå¡æ± 
    </h1>
    <p class="text-gray-500 mb-8 text-base">æ¯å¤©ä¸€æ¬¡ï¼Œé”é”çš„ç‰¹æƒç”±æƒ…æƒ…å†³å®šï¼</p>
    
    <!-- ä¸»å†…å®¹åŒºï¼šå·¦è¾¹æ˜¯æŠ½å¡ï¼Œå³è¾¹æ˜¯å›¾é‰´ (lg:grid for desktop) -->
    <div class="main-content w-full">
        
        <!-- å·¦ä¾§ï¼šæŠ½å¡åŒº -->
        <div class="flex flex-col items-center text-center w-full max-w-md mx-auto lg:mx-0">

            <!-- è¿Ÿåˆ°è¡¥æ•‘åŒºåŸŸ -->
            <div id="late-save-container" class="w-full mb-6 hidden">
                <div id="late-timer" class="text-lg font-bold text-red-600 bg-red-100 p-3 rounded-lg shadow-md mb-3 border-2 border-red-300">
                    <!-- è®¡æ—¶å™¨å®æ—¶æ›´æ–° -->
                </div>
                <button id="late-button" onclick="activateLateSave()" class="w-full py-3 px-6 bg-red-500 hover:bg-red-600 text-white font-bold rounded-xl shadow-lg transform transition duration-150 active:scale-95 text-base">
                    â±ï¸ è¿Ÿåˆ°è¡¥æ•‘ï¼šç‚¹å‡»è·å–ä»Šå¤©çš„æŠ½å¡æœºä¼šï¼
                </button>
            </div>


            <!-- æŠ½å¡ç»“æœåŒºåŸŸ -->
            <div id="card-result" class="card-container w-full">
                <div id="card-inner" class="card-inner h-full w-full">
                    
                    <!-- å¡ç‰‡èƒŒé¢ (åˆå§‹çŠ¶æ€) -->
                    <div id="card-back" class="card-back w-full h-full rounded-2xl bg-gradient-to-br from-pink-500 to-red-600 flex items-center justify-center border-4 border-pink-200 shadow-xl p-6">
                        <span class="text-white text-3xl font-extrabold tracking-widest text-shadow">ç‚¹å‡»æŠ½å¡</span>
                    </div>

                    <!-- å¡ç‰‡æ­£é¢ (ç»“æœæ˜¾ç¤º) -->
                    <div id="card-face" class="card-face w-full h-full rounded-2xl p-6 shadow-2xl flex flex-col justify-between items-center text-center">
                        <div class="text-4xl font-black mb-2 text-shadow" id="rarity-display"></div>
                        <p class="text-base font-medium mb-4 text-gray-700" id="description-display"></p>
                        <div class="text-xl font-extrabold p-3 rounded-full w-full shadow-md" id="title-display"></div>
                    </div>
                </div>
            </div>

            <!-- æŒ‰é’®åŒºåŸŸ -->
            <button id="draw-button" onclick="drawCard()" class="w-full mt-10 py-5 px-6 bg-pink-500 hover:bg-pink-600 text-white font-black rounded-2xl shadow-xl transform transition duration-150 active:scale-95 text-xl tracking-wider">
                æŠ½å–ä»Šæ—¥ç‰¹æƒå¡ï¼
            </button>
            
            <!-- æç¤ºä¿¡æ¯ -->
            <p id="message" class="mt-4 text-sm text-red-600 font-semibold hidden p-3 bg-red-100 rounded-lg w-full max-w-xs mx-auto shadow">ä»Šæ—¥ç‰¹æƒå·²ä½¿ç”¨ï¼Œæ˜å¤©å†æ¥å“¦ï¼</p>
        </div>

        <!-- å³ä¾§ï¼šæƒ…æƒ…ç‰¹æƒå›¾é‰´ -->
        <div class="w-full mt-8 lg:mt-0 collection-sidebar">
            <h2 class="text-2xl font-black text-gray-700 mb-4 border-b pb-2">
                æƒ…æƒ…ç‰¹æƒå›¾é‰´ 
                <span id="card-count" class="text-base font-normal text-pink-500 ml-2"></span>
            </h2>
            <div id="collection-list" class="space-y-3">
                <p class="text-gray-500" id="collection-placeholder">æŠ½å–ç¬¬ä¸€å¼ å¡åï¼Œå›¾é‰´ä¼šè‡ªåŠ¨æ˜¾ç¤ºåœ¨è¿™é‡Œå“¦ï¼</p>
                <!-- å¡ç‰‡åˆ—è¡¨å°†ç”± JS åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

    </div>

    <script>
        // å¡ç‰‡æ•°æ®ï¼šç¨€æœ‰åº¦ã€æ ‡é¢˜ã€æè¿°
        const ALL_CARDS = {
            'S': [
                { title: "ã€ç»å¯¹æŒ‡ä»¤æƒã€‘", desc: "ä»Šæ—¥é”é”éœ€æ— æ¡ä»¶æ¥å—æƒ…æƒ…çš„ä¸€æ¡æŒ‡ä»¤ï¼ˆé™åˆç†èŒƒå›´ï¼‰ï¼", color: "rarity-S" },
                { title: "ã€æ€å¿µçš„æ·±åº¦æé—®ã€‘", desc: "æƒ…æƒ…ä»Šæ™šå¯å‘é”é”æå‡ºä¸¤ä¸ªæœ€ç§å¯†ã€æœ€æ¸´æœ›çŸ¥é“çš„ã€å…³äºèº«ä½“çš„æ·±åº¦é—®é¢˜ï¼Œé”é”å¿…é¡»å¦‚å®å›ç­”å¹¶è¿›è¡Œæœ€ç»†èŠ‚çš„æè¿°ã€‚", color: "rarity-S" },
                { title: "ã€æœªæ¥åŒå±…å¤œã€‘", desc: "ä¸‹æ¬¡è¿çº¿ï¼Œæƒ…æƒ…å¯è¦æ±‚é”é”å…³é—­ç¯å…‰ï¼Œä¸¤äººç›–ä¸Šè¢«å­ï¼Œåªç”¨ç§å¯†çš„â€˜æ°”éŸ³â€™ï¼Œäº’ç›¸è®²è¿°å¯¹æœªæ¥åŒå±…ç”Ÿæ´»çš„ä¸‰ä¸ªæœ€å¤§æœŸå¾…ã€‚", color: "rarity-S" },
                { title: "ã€ä¸Šå¸è§†è§’ã€‘", desc: "è‡ªå®šä¹‰è‡³å¤šäº”å¼ ä»»æ„ç­‰çº§çš„å¡ï¼Œå¹¶é€‰æ‹©ä¸€å¼ ç«‹åˆ»æ‰§è¡Œã€‚", color: "rarity-S" },
                { title: "ã€æ‹çˆ±å‰§æœ¬å¯¼æ¼”ã€‘", desc: "æƒ…æƒ…å†™ä¸€ä¸ªâ€œå°æƒ…èŠ‚â€ï¼Œé”é”å¿…é¡»æŠŠå®ƒå®Œæ•´æ¼”å‡ºæ¥ï¼ˆè¯­éŸ³/æ–‡å­—/å‰§æƒ…çš†å¯ï¼Œåªè¦å¥åº·ä¸è¶Šç•Œï¼‰ã€‚", color: "rarity-S" }
            ],
            'A': [
                { title: "ã€æŠ±æŠ±å¬å”¤å¡ã€‘", desc: "æƒ…æƒ…éšæ—¶è¯´ä¸€å£°ï¼Œé”é”å°±ç»™æƒ…æƒ…ä¸€ä¸ªæŠ±æŠ±ï¼ˆæˆ–è¯­éŸ³ç‰ˆæŠ±æŠ±ï¼‰ã€‚", color: "rarity-A" },
                { title: "ã€æŒ‡å®šå¤¸å¤¸å¡ã€‘", desc: "æƒ…æƒ…å¯ä»¥è¦æ±‚é”é”é’ˆå¯¹æŸä¸ªæ–¹é¢å¤¸æƒ…æƒ…ï¼Œé”é”å¿…é¡»å¤¸åˆ°æƒ…æƒ…æ»¡æ„ä¸ºæ­¢ã€‚", color: "rarity-A" },
                { title: "ã€ç”œåº¦å‡çº§å¡ã€‘", desc: "ä»Šå¤©æƒ…æƒ…å¯ä»¥è¦æ±‚é”é”è¯´ä¸€å¥å¹³æ—¶ä¸å¥½æ„æ€è¯´çš„æƒ…è¯ã€‚", color: "rarity-A" },
                { title: "ã€å°ä»»æ€§ä¿æŠ¤å¡ã€‘", desc: "ä»Šå¤©æƒ…æƒ…å¯ä»¥ä»»æ€§ä¸€æ¬¡ï¼Œé”é”å¿…é¡»æ— æ¡ä»¶æ¥ä½ï¼ˆå°äº‹èŒƒå›´ï¼‰ã€‚", color: "rarity-A" },
                { title: "ã€ç¡å‰é™ªä¼´å¡ã€‘", desc: "ä»Šæ™šé”é”å¿…é¡»é™ªæƒ…æƒ…åˆ°æƒ…æƒ…å…¥ç¡ï¼ˆæˆ–èƒ½é™ªåˆ°æƒ…æƒ…å®‰å¿ƒä¸ºæ­¢ï¼‰ã€‚", color: "rarity-A" },
                { title: "ã€ä»Šæ—¥æ„¿æœ›è®¸å¯å¡ã€‘", desc: "æƒ…æƒ…å¯ä»¥æä¸€ä¸ªå°æ„¿æœ›ï¼Œé”é”éœ€è¦åœ¨ä»Šå¤©å®Œæˆã€‚", color: "rarity-A" },
                { title: "ã€éšæœºç”œèœœä»»åŠ¡å¡ã€‘", desc: "æƒ…æƒ…ä»Šå¤©å¯ä»¥è®©é”é”ä¸ºæƒ…æƒ…åšä¸€ä»¶â€˜è¶…å°ä½†è¶…æš–å¿ƒâ€™çš„äº‹ï¼Œç”±æƒ…æƒ…æŒ‡å®šã€‚", color: "rarity-A" },
                { title: "ã€æ—©ç¡å¼ºåˆ¶ä»¤ã€‘", desc: "é”é”ä»Šæ—¥å¿…é¡»åœ¨æƒ…æƒ…æŒ‡å®šçš„æ—¶é—´ç¡è§‰ï¼Œä¸è®¸ç†¬å¤œå­¦ä¹ ï¼", color: "rarity-A" }
            ],
            'B': [
                { title: "ã€å°å°å‘½ä»¤å¡ã€‘", desc: "æƒ…æƒ…å¯ä»¥å‘½ä»¤é”é”åšä¸€ä»¶éå¸¸å°çš„äº‹æƒ…ï¼Œæ¯”å¦‚â€˜å–æ°´â€™â€˜æ‹çŒ«çŒ«æ‰‹åŠ¿â€™ã€‚", color: "rarity-B" },
                { title: "ã€æƒ…ç»ªå¤©çº¿å¡ã€‘", desc: "æƒ…æƒ…ä»Šå¤©è¯´ä¸€å¥â€œé”é”æœ‰ç‚¹æƒ…ç»ªâ€ï¼Œé”é”å¿…é¡»é©¬ä¸Šåˆ‡æ¢æˆé™ªä¼´æ¨¡å¼ã€‚", color: "rarity-B" },
                { title: "ã€è¯­éŸ³é€‰æ‰‹å¡ã€‘", desc: "æƒ…æƒ…å¯ä»¥è¦æ±‚é”é”å‘ä¸€æ¡æƒ…æƒ…æŒ‡å®šé£æ ¼çš„è¯­éŸ³ï¼ˆå¯çˆ±/ä½æ²‰/ææ€ªï¼‰ã€‚", color: "rarity-B" },
                { title: "ã€å¥½æ¶ˆæ¯é€Ÿé€’å¡ã€‘", desc: "ä»Šå¤©é”é”å¿…é¡»ç»™æƒ…æƒ…ä¼ é€’ä¸‰ä»¶çœŸå®çš„å°å¥½æ¶ˆæ¯ã€‚", color: "rarity-B" },
                { title: "ã€è¡¨æƒ…åŒ…æŠ•å–‚å¡ã€‘", desc: "æƒ…æƒ…å¯ä»¥éšæ—¶å–Šâ€˜é”é”è¦â€™ï¼Œé”é”å¿…é¡»ç»™æƒ…æƒ…æŠ•å–‚ä¸€æ³¢è¡¨æƒ…åŒ…ã€‚", color: "rarity-B" },
                { title: "ã€æ¸…é†’ç›‘ç£å¡ã€‘", desc: "æƒ…æƒ…ä»Šå¤©å¯ä»¥ç›‘ç£é”é”ä¸€ä»¶é”é”æƒ³åšæŒçš„å°äº‹ã€‚", color: "rarity-B" },
                { title: "ã€ä»Šæ—¥å°å¹¸è¿å¡ã€‘", desc: "é”é”å¿…é¡»ç»™æƒ…æƒ…è¯´ä¸€ä»¶æƒ…æƒ…ä»Šå¤©ä¼šé‡åˆ°çš„å°å¹¸è¿ï¼ˆé¢„è¨€å‹ï¼‰ã€‚", color: "rarity-B" },
                { title: "ã€ç”Ÿæ´»å»ºè®®å¡ã€‘", desc: "æƒ…æƒ…é—®ä»»ä½•å°é—®é¢˜ï¼Œé”é”å¿…é¡»è®¤çœŸç»™å‡ºä¸€ä¸ªé è°±å»ºè®®ã€‚", color: "rarity-B" },
                { title: "ã€æƒ…æ„Ÿç”µé‡è¡¥ç»™å¡ã€‘", desc: "æƒ…æƒ…è¯´ç¼ºç”µï¼Œé”é”å¿…é¡»ç«‹åˆ»è¡¥ç»™ä¸€å¥åŠ¨åŠ›è¯ã€‚", color: "rarity-B" },
                { title: "ã€ç…§ç‰‡å¬å”¤å¡ã€‘", desc: "æƒ…æƒ…å¯ä»¥è¦æ±‚é”é”æ‹ä¸€å¼ å½“ä¸‹çš„å°ç…§ç‰‡ï¼ˆåœºæ™¯éšç¼˜ï¼‰ã€‚", color: "rarity-B" }
            ]
        };

        // æ¦‚ç‡é…ç½®
        const rarityChances = {
            'S': 10, 
            'A': 30, 
            'B': 60  
        };

        // DOM å…ƒç´ å¼•ç”¨
        const drawButton = document.getElementById('draw-button');
        const lateSaveContainer = document.getElementById('late-save-container');
        const lateTimer = document.getElementById('late-timer');
        const cardInner = document.getElementById('card-inner');
        const messageDisplay = document.getElementById('message');
        const collectionList = document.getElementById('collection-list');
        const cardCount = document.getElementById('card-count');

        // LocalStorage Key
        const lastDrawKey = 'lastDrawDate';
        const lateSaveActivatedKey = 'lateSaveActivated'; 
        const collectedCardsKey = 'collectedCards'; // æ–°å¢ï¼šç”¨äºå­˜å‚¨å›¾é‰´æ•°æ®
        const lastDrawnTitleKey = 'lastDrawnTitle'; // ç”¨äºå­˜å‚¨ä¸Šæ¬¡æŠ½å–çš„å¡ç‰‡æ ‡é¢˜

        // --- CST æ—¶é—´å’Œé€»è¾‘å‡½æ•° ---

        function getCSTTime() {
            const now = new Date();
            const utcTime = now.getTime() + (now.getTimezoneOffset() * 60000); 
            const cstTime = new Date(utcTime + (8 * 3600000)); // åŒ—äº¬æ—¶é—´ (CST/GMT+8)
            return cstTime;
        }

        // åˆ·æ–°ç‚¹ä¸º CST 5:00 AM
        function getCSTResetDateString(cstTime) {
            const cstHour = cstTime.getHours();
            
            // å¦‚æœæ—¶é—´åœ¨ 00:00 åˆ° 04:59 CST ä¹‹é—´ï¼Œ'æŠ½å¡æ—¥'æ˜¯å‰ä¸€å¤© (å› ä¸º5ç‚¹æ‰åˆ·æ–°)
            if (cstHour < 5) { 
                const previousDay = new Date(cstTime.getTime() - 24 * 3600000);
                return previousDay.toISOString().slice(0, 10);
            }
            return cstTime.toISOString().slice(0, 10);
        }

        // æ£€æŸ¥æ˜¯å¦åœ¨æŠ½å¡æ—¶é—´çª—å†… (CST 5:00 AM - 10:00 AM)
        function checkAccessWindow(cstTime) {
            const cstHour = cstTime.getHours();
            return cstHour >= 5 && cstHour < 10;
        }

        // æ£€æŸ¥æ˜¯å¦åœ¨è¿Ÿåˆ°è¡¥æ•‘æ—¶é—´çª—å†… (CST 10:00 AM - 10:30 AM)
        function checkLateSaveWindow(cstTime) {
            const cstHour = cstTime.getHours();
            const cstMinute = cstTime.getMinutes();
            // 10ç‚¹ï¼ˆå«ï¼‰åˆ° 10ç‚¹30åˆ†ï¼ˆä¸å«ï¼‰
            return cstHour === 10 && cstMinute < 30;
        }

        // --- è¿Ÿåˆ°è¡¥æ•‘æ¿€æ´»å‡½æ•° ---
        window.activateLateSave = function() {
            const cstTime = getCSTTime();
            const todayResetString = getCSTResetDateString(cstTime);

            if (localStorage.getItem(lateSaveActivatedKey) === todayResetString) {
                 return; // ä»Šå¤©å·²ä½¿ç”¨
            }

            // æ¢å¤ä»Šæ—¥æŠ½å¡æ¬¡æ•° (ç§»é™¤ lastDrawDateï¼Œç›¸å½“äºæ²¡æŠ½è¿‡)
            localStorage.removeItem(lastDrawKey);
            // æ ‡è®°ä»Šå¤©å·²ä½¿ç”¨è¡¥æ•‘
            localStorage.setItem(lateSaveActivatedKey, todayResetString);
            
            // ç«‹å³åˆ·æ–°çŠ¶æ€å’ŒæŒ‰é’®æ–‡æœ¬
            checkDrawStatus();
        }

        // --- å›¾é‰´ç®¡ç†å‡½æ•° ---

        function getCollectedCards() {
            try {
                const json = localStorage.getItem(collectedCardsKey);
                return json ? JSON.parse(json) : [];
            } catch (e) {
                console.error("Error loading collected cards:", e);
                return [];
            }
        }

        function saveCollectedCards(cards) {
            localStorage.setItem(collectedCardsKey, JSON.stringify(cards));
        }

        // åˆ‡æ¢å¡ç‰‡ä½¿ç”¨çŠ¶æ€
        window.toggleCardUsage = function(title) {
            let cards = getCollectedCards();
            const cardIndex = cards.findIndex(c => c.title === title);
            
            if (cardIndex !== -1) {
                cards[cardIndex].used = !cards[cardIndex].used;
                saveCollectedCards(cards);
                renderCollection(); // é‡æ–°æ¸²æŸ“å›¾é‰´
            }
        }

        function renderCollection() {
            const cards = getCollectedCards().sort((a, b) => {
                // æ’åºé€»è¾‘ï¼šS > A > Bï¼Œç„¶åæŒ‰æ ‡é¢˜å­—æ¯é¡ºåº
                const rarityOrder = {'S': 3, 'A': 2, 'B': 1};
                if (rarityOrder[b.rarity] !== rarityOrder[a.rarity]) {
                    return rarityOrder[b.rarity] - rarityOrder[a.rarity];
                }
                return a.title.localeCompare(b.title);
            });

            collectionList.innerHTML = '';
            cardCount.textContent = `(å·²æ”¶é›† ${cards.length} ç§)`;

            // Get the placeholder element safely
            const placeholder = document.getElementById('collection-placeholder');

            if (cards.length === 0) {
                if (placeholder) {
                   placeholder.classList.remove('hidden');
                }
                return;
            }
            
            if (placeholder) {
                placeholder.classList.add('hidden');
            }


            cards.forEach(card => {
                const buttonColor = card.used ? 'bg-gray-400 hover:bg-gray-500' : 'bg-green-500 hover:bg-green-600';
                const statusText = card.used ? 'âœ… å·²ä½¿ç”¨' : 'ğŸŒŸ æœªä½¿ç”¨';
                const rarityClass = card.color.replace('rarity-', 'text-');
                
                const cardHtml = `
                    <div class="p-3 border rounded-lg shadow-sm flex justify-between items-center text-sm ${card.used ? 'opacity-60 bg-gray-50' : 'bg-white'}">
                        <div class="flex flex-col text-left">
                            <span class="font-bold ${rarityClass}">${card.title}</span>
                            <span class="text-xs text-gray-500">${card.rarity} çº§ç‰¹æƒ</span>
                        </div>
                        <button onclick="toggleCardUsage('${card.title}')" class="py-1 px-3 ${buttonColor} text-white font-semibold rounded-full transition duration-150 text-xs shadow-md">
                            ${statusText}
                        </button>
                    </div>
                `;
                collectionList.innerHTML += cardHtml;
            });
        }


        // --- UI çŠ¶æ€æ£€æŸ¥å‡½æ•° ---

        function updateLateSaveUI(cstTime) {
            const isLateWindow = checkLateSaveWindow(cstTime);
            const todayResetString = getCSTResetDateString(cstTime);
            const lateSaveUsed = localStorage.getItem(lateSaveActivatedKey) === todayResetString;
            const lastDrawDate = localStorage.getItem(lastDrawKey);
            
            // 1. è®¡ç®—å‰©ä½™æ—¶é—´
            const targetTime = new Date(cstTime);
            targetTime.setHours(10, 30, 0, 0); // CST 10:30 AM
            const timeDiff = targetTime.getTime() - cstTime.getTime();
            const minutesLeft = Math.floor(timeDiff / 60000);

            if (isLateWindow && !lateSaveUsed && lastDrawDate === todayResetString) {
                // åœ¨æ—¶é—´çª—å†…ã€æœªä½¿ç”¨è¡¥æ•‘ã€ä¸”å·²ç»æŠ½è¿‡å¡ (éœ€è¦è¡¥æ•‘)
                lateSaveContainer.classList.remove('hidden');
                lateTimer.textContent = `æœ€åçš„æœºä¼šï¼è¿˜æœ‰ ${minutesLeft} åˆ†é’Ÿï¼ç‚¹å‡»è¡¥æ•‘æŠ½å¡ï¼`;
            } else if (isLateWindow && !lateSaveUsed && lastDrawDate !== todayResetString) {
                 // åœ¨æ—¶é—´çª—å†…ã€æœªä½¿ç”¨è¡¥æ•‘ã€ä½†è¿˜æ²¡æŠ½å¡ (æƒ…æƒ…æ˜¯æŒ‰æ—¶èµ·çš„ï¼Œåªæ˜¯åœ¨ 10:00-10:30 ä¹‹é—´æŠ½)
                lateSaveContainer.classList.add('hidden');
            } else {
                lateSaveContainer.classList.add('hidden');
            }
        }

        function checkDrawStatus() {
            const cstTime = getCSTTime();
            const todayResetString = getCSTResetDateString(cstTime);
            const lastDrawDate = localStorage.getItem(lastDrawKey);
            const inWindow = checkAccessWindow(cstTime);
            const isLateWindow = checkLateSaveWindow(cstTime);

            const alreadyDrawnMessage = `ä»Šæ—¥ç‰¹æƒå·²æŠ½å–ï¼Œæ˜å¤©åŒ—äº¬æ—¶é—´å‡Œæ™¨5ç‚¹åˆ·æ–°åæ‰èƒ½å†æ¥å“¦ï¼`;
            const outOfWindowMessage = 'ä»Šå¤©å®å®æ²¡æœ‰æŒ‰æ—¶æ—©èµ·å“¦ï¼è¯·åœ¨åŒ—äº¬æ—¶é—´æ—©ä¸Š5ç‚¹è‡³10ç‚¹ä¹‹é—´å†æ¥æŠ½å–ä½ çš„ç‰¹æƒï¼';
            
            // 1. å®æ—¶æ›´æ–°è¿Ÿåˆ°è¡¥æ•‘UI
            updateLateSaveUI(cstTime);

            // 2. æ£€æŸ¥æ¯æ—¥æŠ½å¡æ¬¡æ•°
            if (lastDrawDate === todayResetString) {
                drawButton.disabled = true;
                drawButton.classList.add('opacity-50', 'cursor-not-allowed');
                drawButton.textContent = 'ä»Šæ—¥ç‰¹æƒå·²æŠ½å–';
                messageDisplay.textContent = alreadyDrawnMessage;
                messageDisplay.classList.remove('hidden');
                return true;
            }

            // 3. æ£€æŸ¥æ—¶é—´çª— (åªæœ‰åœ¨æœªæŠ½å¡æ—¶æ‰æ£€æŸ¥)
            if (!inWindow && !isLateWindow) {
                drawButton.disabled = true;
                drawButton.classList.add('opacity-50', 'cursor-not-allowed');
                drawButton.textContent = 'è¯·åœ¨ 5:00 - 10:00 æŠ½å–';
                messageDisplay.textContent = outOfWindowMessage;
                messageDisplay.classList.remove('hidden');
                return true;
            }
            
            // 4. æ­£å¸¸æŠ½å¡çŠ¶æ€
            drawButton.disabled = false;
            drawButton.classList.remove('opacity-50', 'cursor-not-allowed');
            drawButton.textContent = 'æŠ½å–ä»Šæ—¥ç‰¹æƒå¡ï¼';
            messageDisplay.classList.add('hidden');
            return false;
        }

        // --- æ ¸å¿ƒæŠ½å¡é€»è¾‘ ---

        window.drawCard = function() {
            if (checkDrawStatus()) return; // æ£€æŸ¥æ˜¯å¦å¯ä»¥æŠ½å¡

            // 1. ç¡®å®šæŠ½åˆ°çš„ç¨€æœ‰åº¦
            let rand = Math.random() * 100;
            let rarity = '';
            
            if (rand < rarityChances['S']) {
                rarity = 'S';
            } else if (rand < rarityChances['S'] + rarityChances['A']) {
                rarity = 'A';
            } else {
                rarity = 'B';
            }

            // 2. ä»è¯¥ç¨€æœ‰åº¦ä¸­éšæœºæŠ½å–ä¸€å¼ å¡
            const cardsOfRarity = ALL_CARDS[rarity];
            const randomIndex = Math.floor(Math.random() * cardsOfRarity.length);
            const drawnCard = cardsOfRarity[randomIndex];

            // 3. æ£€æŸ¥æ˜¯å¦é‡å¤
            const lastDrawnTitle = localStorage.getItem(lastDrawnTitleKey); // è·å–ä¸Šæ¬¡æŠ½å–çš„å¡ç‰‡æ ‡é¢˜
            const isRepeat = (lastDrawnTitle === drawnCard.title);

            // 4. åŠ¨ç”»å’ŒçŠ¶æ€æ›´æ–°
            drawButton.disabled = true;
            drawButton.textContent = 'æŠ½å–ä¸­...';
            
            document.getElementById('card-result').classList.remove('flipped');
            cardInner.classList.remove('flipped'); 

            setTimeout(() => {
                const cardFace = document.getElementById('card-face');
                const titleDisplay = document.getElementById('title-display');
                const descriptionDisplay = document.getElementById('description-display');
                const rarityDisplay = document.getElementById('rarity-display');

                // 4a. è®¾ç½®å¡ç‰‡æ ·å¼å’Œå†…å®¹
                cardFace.className = 'card-face w-full h-full rounded-2xl p-6 shadow-2xl flex flex-col justify-between items-center text-center';

                if (isRepeat) {
                    cardFace.classList.add('rarity-R');
                    rarityDisplay.textContent = 'âš ï¸ é‡å¤å¡ï¼šç‰¹æƒå·²å‡çº§ï¼';
                    titleDisplay.textContent = drawnCard.title;
                    descriptionDisplay.textContent = `æƒ…æƒ…ï¼Œä½ æŠ½åˆ°äº†åŒæ ·çš„å¡ï¼ç‰¹æƒç­‰çº§è‡ªåŠ¨+1ï¼Œé”é”ä¼šåŠ å€åŠªåŠ›æ‰§è¡Œï¼`;
                } else {
                    cardFace.classList.add(drawnCard.color);
                    rarityDisplay.textContent = 'â­ï¸ ' + rarity + ' çº§ç‰¹æƒ â­ï¸';
                    titleDisplay.textContent = drawnCard.title;
                    descriptionDisplay.textContent = drawnCard.desc;
                }

                // 4b. ç¿»è½¬å¡ç‰‡
                document.getElementById('card-result').classList.add('flipped');
                cardInner.classList.add('flipped');

                // 4c. æ›´æ–°æ°¸ä¹…çŠ¶æ€
                // æ ‡è®°ä»Šå¤©å·²æŠ½å¡
                const cstTime = getCSTTime();
                const todayResetString = getCSTResetDateString(cstTime);
                localStorage.setItem(lastDrawKey, todayResetString); 
                localStorage.setItem(lastDrawnTitleKey, drawnCard.title); // æ›´æ–°ä¸Šæ¬¡æŠ½å–çš„å¡ç‰‡æ ‡é¢˜

                // æ›´æ–°å›¾é‰´
                addCardToCollection(drawnCard, rarity);
                
                // 4d. æ¢å¤æŒ‰é’®çŠ¶æ€
                setTimeout(checkDrawStatus, 1000); 

            }, 500); 
        }

        // ä»…åœ¨å¡ç‰‡ä¸å­˜åœ¨äºå›¾é‰´ä¸­æ—¶æ·»åŠ 
        function addCardToCollection(card, rarity) {
            let cards = getCollectedCards();
            const exists = cards.some(c => c.title === card.title);

            if (!exists) {
                cards.push({
                    title: card.title,
                    desc: card.desc,
                    color: card.color,
                    rarity: rarity,
                    used: false // é»˜è®¤æœªè¢«ä½¿ç”¨
                });
                saveCollectedCards(cards);
            }
            renderCollection();
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥çŠ¶æ€å¹¶å¯åŠ¨å®šæ—¶å™¨
        document.addEventListener('DOMContentLoaded', () => {
            renderCollection(); // åˆå§‹åŒ–å›¾é‰´
            checkDrawStatus();
            // æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡UIï¼Œç¡®ä¿è®¡æ—¶å™¨å’ŒçŠ¶æ€åŠæ—¶åˆ·æ–°
            setInterval(checkDrawStatus, 60000); 
        });
    </script>
</body>
</html>
